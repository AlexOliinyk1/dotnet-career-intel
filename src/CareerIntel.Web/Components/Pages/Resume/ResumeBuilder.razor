@page "/resume"
@using CareerIntel.Matching
@using CareerIntel.Resume
@inject VacancyRepository VacancyRepo
@inject DataDirectoryConfig DataDir
@inject CareerIntel.Resume.ResumeBuilder ResumeEngine
@inject CoverLetterGenerator CoverLetterEngine

<div class="page-header">
    <h1 class="page-title">Resume Builder</h1>
    <p class="page-subtitle">Generate tailored resumes and cover letters for specific job vacancies</p>
</div>

<LoadingSpinner Loading="@_loading" Message="Loading vacancies..." />

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="card" style="border-left: 3px solid var(--color-red, #e74c3c); margin-bottom: 1rem;">
        <strong style="color: var(--color-red, #e74c3c);">Error:</strong> @_errorMessage
    </div>
}

@if (!_loading)
{
    <div class="card">
        <h2 class="card-title">Select Target Vacancy</h2>
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label>Target Vacancy</label>
                <select @bind="_selectedVacancyId" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color, #444); background: var(--bg-secondary, #2a2a2a); color: inherit;">
                    <option value="">-- Select a vacancy --</option>
                    @foreach (var v in _vacancies)
                    {
                        <option value="@v.Id">@v.Title - @v.Company (@v.SeniorityLevel)</option>
                    }
                </select>
            </div>
        </div>
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
            <button class="btn btn-primary" @onclick="GenerateResume" disabled="@(string.IsNullOrEmpty(_selectedVacancyId) || _generating)">
                @if (_generating && _generatingResume)
                {
                    <span>Generating...</span>
                }
                else
                {
                    <span>Generate Resume</span>
                }
            </button>
            <button class="btn" @onclick="GenerateCoverLetter" disabled="@(string.IsNullOrEmpty(_selectedVacancyId) || _generating)">
                @if (_generating && !_generatingResume)
                {
                    <span>Generating...</span>
                }
                else
                {
                    <span>Generate Cover Letter</span>
                }
            </button>
        </div>
    </div>

    @if (_selectedVacancy is not null)
    {
        <div class="card" style="margin-top: 1.5rem;">
            <h2 class="card-title">Vacancy Details</h2>
            <div class="card-grid">
                <StatCard Label="Company" Value="@_selectedVacancy.Company" />
                <StatCard Label="Position" Value="@_selectedVacancy.Title" />
                <StatCard Label="Seniority" Value="@_selectedVacancy.SeniorityLevel.ToString()" />
                <StatCard Label="Remote Policy" Value="@_selectedVacancy.RemotePolicy.ToString()" />
            </div>

            @if (_selectedVacancy.RequiredSkills.Count > 0)
            {
                <div style="margin-top: 1rem;">
                    <h3 class="section-title">Required Skills</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                        @foreach (var skill in _selectedVacancy.RequiredSkills)
                        {
                            var hasSkill = _yourSkills.Contains(skill, StringComparer.OrdinalIgnoreCase);
                            <StatusBadge Text="@skill" Color="@(hasSkill ? "green" : "red")" />
                        }
                    </div>
                </div>
            }

            @if (_selectedVacancy.PreferredSkills.Count > 0)
            {
                <div style="margin-top: 1rem;">
                    <h3 class="section-title">Preferred Skills</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                        @foreach (var skill in _selectedVacancy.PreferredSkills)
                        {
                            var hasSkill = _yourSkills.Contains(skill, StringComparer.OrdinalIgnoreCase);
                            <StatusBadge Text="@skill" Color="@(hasSkill ? "green" : "yellow")" />
                        }
                    </div>
                </div>
            }
        </div>
    }

    @if (_showResume && !string.IsNullOrEmpty(_generatedResumeMarkdown))
    {
        <div class="card" style="margin-top: 1.5rem;">
            <h2 class="card-title">Generated Tailored Resume</h2>

            <div class="stat-card" style="margin-top: 1rem;">
                <h3 class="section-title">Resume Preview</h3>
                <div style="white-space: pre-line; line-height: 1.6; font-family: inherit;">@_generatedResumeMarkdown</div>
            </div>

            <div class="stat-card" style="margin-top: 1rem;">
                <h3 class="section-title">Skills Match</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Required Skill</th>
                            <th>Your Status</th>
                            <th>Resume Highlight</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var skill in _selectedVacancy?.RequiredSkills ?? [])
                        {
                            var hasSkill = _yourSkills.Contains(skill, StringComparer.OrdinalIgnoreCase);
                            <tr>
                                <td><strong>@skill</strong></td>
                                <td>
                                    <StatusBadge Text="@(hasSkill ? "Match" : "Gap")"
                                                 Color="@(hasSkill ? "green" : "red")" />
                                </td>
                                <td>
                                    @if (hasSkill)
                                    {
                                        @($"Highlighted in tailored resume")
                                    }
                                    else
                                    {
                                        @($"Not in your profile - consider adding transferable skills")
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="stat-card" style="margin-top: 1rem;">
                <h3 class="section-title">ATS Keywords Included</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                    @foreach (var keyword in _atsKeywords)
                    {
                        <span class="badge">@keyword</span>
                    }
                </div>
            </div>
        </div>
    }

    @if (_showCoverLetter && !string.IsNullOrEmpty(_generatedCoverLetter))
    {
        <div class="card" style="margin-top: 1.5rem;">
            <h2 class="card-title">Generated Cover Letter</h2>

            <div class="stat-card" style="margin-top: 1rem;">
                <div style="white-space: pre-line; line-height: 1.6;">@_generatedCoverLetter</div>
            </div>
        </div>
    }

    @if (!_showResume && !_showCoverLetter && _selectedVacancy is null)
    {
        <div class="card" style="margin-top: 1.5rem;">
            <h3 class="card-title">How to Use</h3>
            <ol style="padding-left: 1.5rem; line-height: 2;">
                <li>Select a target vacancy from the dropdown above</li>
                <li>Click <strong>Generate Resume</strong> to create tailored resume sections</li>
                <li>Click <strong>Generate Cover Letter</strong> for a customized cover letter</li>
                <li>Review the skills match analysis to optimize your application</li>
            </ol>
        </div>
    }

    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
        <a href="/resume/simulator" class="btn btn-primary">Resume Simulator</a>
        <a href="/jobs" class="btn">Browse Jobs</a>
    </div>
}

@code {
    private bool _loading = true;
    private bool _generating;
    private bool _generatingResume;
    private List<JobVacancy> _vacancies = [];
    private string _selectedVacancyId = "";
    private JobVacancy? _selectedVacancy;
    private bool _showResume;
    private bool _showCoverLetter;
    private List<string> _atsKeywords = [];
    private string _generatedResumeMarkdown = "";
    private string _generatedCoverLetter = "";
    private string _errorMessage = "";

    // Loaded from user profile (my-profile.json)
    private UserProfile? _userProfile;
    private List<string> _yourSkills = [];

    protected override async Task OnInitializedAsync()
    {
        await LoadUserProfile();

        _vacancies = (await VacancyRepo.GetVacanciesAsync())
            .OrderByDescending(v => v.ScrapedDate)
            .Take(50)
            .ToList();

        _loading = false;
    }

    private async Task LoadUserProfile()
    {
        var profilePath = Path.Combine(DataDir.Path, "my-profile.json");
        if (!File.Exists(profilePath)) return;

        try
        {
            var json = await File.ReadAllTextAsync(profilePath);
            _userProfile = JsonSerializer.Deserialize<UserProfile>(json,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (_userProfile?.Skills is not null)
            {
                _yourSkills = _userProfile.Skills
                    .Select(s => s.SkillName)
                    .Where(s => !string.IsNullOrEmpty(s))
                    .ToList();
            }
        }
        catch
        {
            // Fallback if profile is malformed
        }

        // Fallback if profile has no skills defined
        if (_yourSkills.Count == 0)
        {
            _yourSkills = ["C#", ".NET", "ASP.NET Core", "Entity Framework", "SQL", "Azure",
                "Docker", "REST API", "Microservices", "Git"];
        }
    }

    private void GenerateResume()
    {
        _errorMessage = "";
        _selectedVacancy = _vacancies.FirstOrDefault(v => v.Id == _selectedVacancyId);
        if (_selectedVacancy is null)
            return;

        _generating = true;
        _generatingResume = true;

        try
        {
            var profile = _userProfile ?? BuildFallbackProfile();

            // Use the ResumeBuilder engine to generate a tailored resume
            _generatedResumeMarkdown = ResumeEngine.Build(profile, _selectedVacancy);

            // Extract ATS keywords from the vacancy
            _atsKeywords = _selectedVacancy.RequiredSkills
                .Concat(_selectedVacancy.PreferredSkills)
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToList();

            _showResume = true;
            _showCoverLetter = false;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to generate resume: {ex.Message}";
        }
        finally
        {
            _generating = false;
        }
    }

    private void GenerateCoverLetter()
    {
        _errorMessage = "";
        _selectedVacancy = _vacancies.FirstOrDefault(v => v.Id == _selectedVacancyId);
        if (_selectedVacancy is null)
            return;

        _generating = true;
        _generatingResume = false;

        try
        {
            var profile = _userProfile ?? BuildFallbackProfile();

            // Use the CoverLetterGenerator engine to generate a tailored cover letter
            _generatedCoverLetter = CoverLetterEngine.Generate(profile, _selectedVacancy);

            _showCoverLetter = true;
            _showResume = false;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to generate cover letter: {ex.Message}";
        }
        finally
        {
            _generating = false;
        }
    }

    /// <summary>
    /// Creates a minimal fallback profile when my-profile.json is unavailable.
    /// </summary>
    private UserProfile BuildFallbackProfile()
    {
        return new UserProfile
        {
            Personal = new PersonalInfo
            {
                Name = "Software Engineer",
                Title = "Senior .NET Developer",
                Summary = "Experienced .NET developer with expertise in backend systems and cloud technologies."
            },
            Skills = _yourSkills.Select(s => new SkillProfile { SkillName = s }).ToList(),
            Experiences = []
        };
    }
}
