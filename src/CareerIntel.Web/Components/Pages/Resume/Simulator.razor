@page "/resume/simulator"
@using CareerIntel.Matching
@using CareerIntel.Resume
@inject VacancyRepository VacancyRepo
@inject DataDirectoryConfig DataDir
@inject ResumeSimulator SimulatorEngine

<div class="page-header">
    <h1 class="page-title">Resume Simulator</h1>
    <p class="page-subtitle">Test your resume against ATS systems, recruiter review, and tech lead evaluation</p>
</div>

<LoadingSpinner Loading="@_loadingVacancies" Message="Loading vacancies..." />

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="card" style="border-left: 3px solid var(--color-red, #e74c3c); margin-bottom: 1rem;">
        <strong style="color: var(--color-red, #e74c3c);">Error:</strong> @_errorMessage
    </div>
}

@if (!_loadingVacancies)
{
    <div class="card">
        <h2 class="card-title">Input</h2>
        <div class="form-group">
            <label>Paste Your Resume Text</label>
            <textarea @bind="_resumeText" rows="12"
                      placeholder="Paste your resume content here (plain text or markdown)..."
                      style="width: 100%; padding: 0.75rem; border-radius: 4px; border: 1px solid var(--border-color, #444); background: var(--bg-secondary, #2a2a2a); color: inherit; font-family: inherit; resize: vertical;">
            </textarea>
        </div>
        <div class="form-row" style="margin-top: 1rem;">
            <div class="form-group" style="flex: 1;">
                <label>Target Vacancy</label>
                <select @bind="_selectedVacancyId"
                        style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color, #444); background: var(--bg-secondary, #2a2a2a); color: inherit;">
                    <option value="">-- Select a vacancy --</option>
                    @foreach (var v in _vacancies)
                    {
                        <option value="@v.Id">@v.Title - @v.Company (@v.SeniorityLevel)</option>
                    }
                </select>
            </div>
        </div>
        <div style="margin-top: 1rem;">
            <button class="btn btn-primary" @onclick="RunSimulation"
                    disabled="@(string.IsNullOrWhiteSpace(_resumeText) || string.IsNullOrEmpty(_selectedVacancyId) || _running)">
                @if (_running)
                {
                    <span>Running Simulation...</span>
                }
                else
                {
                    <span>Run Simulation</span>
                }
            </button>
        </div>
    </div>

    @if (_simulationRun && _simulation is not null)
    {
        <div class="card-grid" style="margin-top: 1.5rem;">
            <StatCard Label="ATS Score" Value="@($"{(int)_simulation.AtsScore.Score}%")"
                      Sub="@(_simulation.AtsScore.PassesFilter ? "Passes ATS filter" : "BLOCKED by ATS")"
                      CssClass="@GetScoreCss((int)_simulation.AtsScore.Score)" />
            <StatCard Label="Recruiter Score" Value="@($"{(int)_simulation.RecruiterScore.Score}%")"
                      Sub="@($"{_simulation.RecruiterScore.ReadTimeSeconds:F1}s read time")"
                      CssClass="@GetScoreCss((int)_simulation.RecruiterScore.Score)" />
            <StatCard Label="Tech Lead Score" Value="@($"{(int)_simulation.TechLeadScore.Score}%")"
                      Sub="@($"{_simulation.TechLeadScore.DepthPercent:F0}% depth")"
                      CssClass="@GetScoreCss((int)_simulation.TechLeadScore.Score)" />
            <StatCard Label="Conversion" Value="@($"{_simulation.OverallConversionProbability:P0}")"
                      Sub="interview probability"
                      CssClass="@GetScoreCss((int)(_simulation.OverallConversionProbability * 100))" />
        </div>

        @* ── ATS Details ────────────────────────────────────────────── *@
        <div class="card-grid" style="margin-top: 1.5rem;">
            <div class="card">
                <h3 class="card-title">ATS: Keyword Matches</h3>
                @{
                    var ats = _simulation.AtsScore;
                    var allKeywords = _selectedVacancy!.RequiredSkills
                        .Concat(_selectedVacancy.PreferredSkills)
                        .Distinct(StringComparer.OrdinalIgnoreCase)
                        .ToList();
                    var matchedKeywords = allKeywords
                        .Where(k => !ats.MissingKeywords.Contains(k, StringComparer.OrdinalIgnoreCase))
                        .ToList();
                }
                @if (matchedKeywords.Count > 0)
                {
                    <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                        @foreach (var keyword in matchedKeywords)
                        {
                            <StatusBadge Text="@keyword" Color="green" />
                        }
                    </div>
                    <p class="text-muted" style="margin-top: 0.75rem;">
                        @matchedKeywords.Count of @allKeywords.Count keywords found (@($"{ats.KeywordMatchPercent:F0}%") match)
                    </p>
                }
                else
                {
                    <p class="text-muted">No keyword matches found.</p>
                }
            </div>

            <div class="card">
                <h3 class="card-title">ATS: Missing Keywords</h3>
                @if (ats.MissingKeywords.Count > 0)
                {
                    <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                        @foreach (var keyword in ats.MissingKeywords)
                        {
                            <StatusBadge Text="@keyword" Color="red" />
                        }
                    </div>
                    <p class="text-muted" style="margin-top: 0.75rem;">
                        Add these keywords to improve your ATS score
                    </p>
                }
                else
                {
                    <p class="text-muted">All keywords found. Excellent coverage!</p>
                }
            </div>
        </div>

        @if (ats.FormatIssues.Count > 0)
        {
            <div class="card" style="margin-top: 1rem;">
                <h3 class="card-title">ATS: Format Issues</h3>
                <div style="display: flex; flex-direction: column; gap: 0.4rem;">
                    @foreach (var issue in ats.FormatIssues)
                    {
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <StatusBadge Text="Warning" Color="yellow" />
                            <span>@issue</span>
                        </div>
                    }
                </div>
            </div>
        }

        @* ── Recruiter Heatmap ──────────────────────────────────────── *@
        <div class="card" style="margin-top: 1.5rem;">
            <h2 class="card-title">Recruiter Eye-Tracking Heatmap</h2>
            <p class="text-muted" style="margin-bottom: 0.75rem;">
                First impression: @_simulation.RecruiterScore.FirstImpression
            </p>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Section</th>
                        <th>Attention</th>
                        <th>Recommendation</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var entry in _simulation.RecruiterScore.Heatmap)
                    {
                        <tr>
                            <td><strong>@entry.Section</strong></td>
                            <td>
                                <StatusBadge Text="@entry.Attention"
                                             Color="@GetAttentionColor(entry.Attention)" />
                            </td>
                            <td>@entry.Recommendation</td>
                        </tr>
                    }
                </tbody>
            </table>

            @if (_simulation.RecruiterScore.Concerns.Count > 0)
            {
                <h4 class="section-title" style="margin-top: 1rem;">Recruiter Concerns</h4>
                <div style="display: flex; flex-direction: column; gap: 0.4rem;">
                    @foreach (var concern in _simulation.RecruiterScore.Concerns)
                    {
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <StatusBadge Text="Concern" Color="orange" />
                            <span>@concern</span>
                        </div>
                    }
                </div>
            }
        </div>

        @* ── Tech Lead Deep-Dive ───────────────────────────────────── *@
        <div class="card" style="margin-top: 1.5rem;">
            <h2 class="card-title">Tech Lead Evaluation</h2>
            <div class="card-grid" style="margin-bottom: 1rem;">
                <StatCard Label="Technical Depth" Value="@($"{_simulation.TechLeadScore.DepthPercent:F0}%")"
                          Sub="depth vs. surface signals"
                          CssClass="@GetScoreCss((int)_simulation.TechLeadScore.DepthPercent)" />
                <StatCard Label="Impressive Points" Value="@_simulation.TechLeadScore.ImpressivePoints.Count.ToString()"
                          Sub="technical highlights" CssClass="text-green" />
                <StatCard Label="Red Flags" Value="@_simulation.TechLeadScore.RedFlags.Count.ToString()"
                          Sub="concerns raised" CssClass="@(_simulation.TechLeadScore.RedFlags.Count > 0 ? "text-red" : "text-green")" />
            </div>

            @if (_simulation.TechLeadScore.ImpressivePoints.Count > 0)
            {
                <h4 class="section-title">What Impressed the Tech Lead</h4>
                <div style="display: flex; flex-direction: column; gap: 0.4rem; margin-bottom: 1rem;">
                    @foreach (var point in _simulation.TechLeadScore.ImpressivePoints)
                    {
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <StatusBadge Text="+" Color="green" />
                            <span>@point</span>
                        </div>
                    }
                </div>
            }

            @if (_simulation.TechLeadScore.RedFlags.Count > 0)
            {
                <h4 class="section-title">Red Flags</h4>
                <div style="display: flex; flex-direction: column; gap: 0.4rem; margin-bottom: 1rem;">
                    @foreach (var flag in _simulation.TechLeadScore.RedFlags)
                    {
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <StatusBadge Text="!" Color="red" />
                            <span>@flag</span>
                        </div>
                    }
                </div>
            }

            @if (_simulation.TechLeadScore.QuestionsWouldAsk.Count > 0)
            {
                <h4 class="section-title">Questions a Tech Lead Would Ask</h4>
                <div style="display: flex; flex-direction: column; gap: 0.4rem;">
                    @foreach (var question in _simulation.TechLeadScore.QuestionsWouldAsk)
                    {
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <StatusBadge Text="?" Color="cyan" />
                            <span>@question</span>
                        </div>
                    }
                </div>
            }
        </div>

        @* ── Critical Issues & Recommendations ────────────────────── *@
        @if (_simulation.CriticalIssues.Count > 0)
        {
            <div class="card" style="margin-top: 1.5rem;">
                <h2 class="card-title">Critical Issues</h2>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    @foreach (var issue in _simulation.CriticalIssues)
                    {
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <StatusBadge Text="Issue" Color="red" />
                            <span>@issue</span>
                        </div>
                    }
                </div>
            </div>
        }

        @if (_simulation.Recommendations.Count > 0)
        {
            <div class="card" style="margin-top: 1.5rem;">
                <h2 class="card-title">Recommendations</h2>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    @foreach (var rec in _simulation.Recommendations)
                    {
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <StatusBadge Text="Fix" Color="cyan" />
                            <span>@rec</span>
                        </div>
                    }
                </div>
            </div>
        }

        @* ── Resume Statistics ─────────────────────────────────────── *@
        <div class="card" style="margin-top: 1.5rem;">
            <h2 class="card-title">Resume Statistics</h2>
            <div class="card-grid">
                <StatCard Label="Word Count" Value="@_wordCount.ToString("N0")" Sub="@GetWordCountAdvice()" />
                <StatCard Label="ATS Pass" Value="@(_simulation.AtsScore.PassesFilter ? "Yes" : "No")"
                          Sub="@(_simulation.AtsScore.PassesFilter ? "resume will be reviewed" : "resume may be filtered out")"
                          CssClass="@(_simulation.AtsScore.PassesFilter ? "text-green" : "text-red")" />
                <StatCard Label="Keywords Matched" Value="@matchedKeywords.Count.ToString()"
                          Sub="@($"of {allKeywords.Count} required")" CssClass="text-cyan" />
                <StatCard Label="Read Time" Value="@($"{_simulation.RecruiterScore.ReadTimeSeconds:F1}s")"
                          Sub="recruiter scan time" CssClass="text-green" />
            </div>
        </div>
    }

    @if (!_simulationRun)
    {
        <div class="card" style="margin-top: 1.5rem;">
            <h3 class="card-title">How the Simulator Works</h3>
            <div class="card-grid">
                <div class="stat-card">
                    <h4 class="section-title">ATS (Applicant Tracking System)</h4>
                    <p>Checks keyword density, required skills coverage, and formatting compatibility with automated resume parsers.</p>
                </div>
                <div class="stat-card">
                    <h4 class="section-title">Recruiter Review</h4>
                    <p>Evaluates clarity, relevance to the role, professional summary quality, and overall first impression during a 6-second scan.</p>
                </div>
                <div class="stat-card">
                    <h4 class="section-title">Tech Lead Evaluation</h4>
                    <p>Assesses technical depth, project complexity signals, architecture awareness, and alignment with the team's tech stack.</p>
                </div>
            </div>
        </div>
    }

    <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
        <a href="/resume" class="btn btn-primary">Resume Builder</a>
        <a href="/jobs" class="btn">Browse Jobs</a>
    </div>
}

@code {
    private bool _loadingVacancies = true;
    private bool _running;
    private List<JobVacancy> _vacancies = [];
    private string _selectedVacancyId = "";
    private JobVacancy? _selectedVacancy;
    private string _resumeText = "";
    private bool _simulationRun;
    private string _errorMessage = "";

    // Simulation result from engine
    private ResumeSimulation? _simulation;

    // User profile for tech lead simulation
    private UserProfile? _userProfile;

    // Stats
    private int _wordCount;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load user profile for tech lead simulation context
            await LoadUserProfile();

            _vacancies = (await VacancyRepo.GetVacanciesAsync())
                .OrderByDescending(v => v.ScrapedDate)
                .Take(50)
                .ToList();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load data: {ex.Message}";
        }
        finally
        {
            _loadingVacancies = false;
        }
    }

    private async Task LoadUserProfile()
    {
        var profilePath = Path.Combine(DataDir.Path, "my-profile.json");
        if (!File.Exists(profilePath)) return;

        try
        {
            var json = await File.ReadAllTextAsync(profilePath);
            _userProfile = JsonSerializer.Deserialize<UserProfile>(json,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
        }
        catch
        {
            // Profile malformed - will use fallback
        }
    }

    private void RunSimulation()
    {
        _errorMessage = "";
        _selectedVacancy = _vacancies.FirstOrDefault(v => v.Id == _selectedVacancyId);
        if (_selectedVacancy is null || string.IsNullOrWhiteSpace(_resumeText))
            return;

        _running = true;

        try
        {
            var profile = _userProfile ?? BuildFallbackProfile();

            // Calculate basic stats
            _wordCount = _resumeText.Split([' ', '\n', '\r', '\t'], StringSplitOptions.RemoveEmptyEntries).Length;

            // Run the full three-reader simulation via the engine
            _simulation = SimulatorEngine.Simulate(_resumeText, _selectedVacancy, profile);

            _simulationRun = true;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Simulation failed: {ex.Message}";
        }
        finally
        {
            _running = false;
        }
    }

    private UserProfile BuildFallbackProfile()
    {
        return new UserProfile
        {
            Personal = new PersonalInfo
            {
                Name = "Software Engineer",
                Title = "Senior .NET Developer",
                Summary = "Experienced .NET developer."
            },
            Skills = new List<string> { "C#", ".NET", "ASP.NET Core", "Entity Framework", "SQL", "Azure",
                "Docker", "REST API", "Microservices", "Git" }
                .Select(s => new SkillProfile { SkillName = s })
                .ToList(),
            Experiences = []
        };
    }

    private string GetWordCountAdvice()
    {
        if (_wordCount < 200) return "too short";
        if (_wordCount < 400) return "slightly short";
        if (_wordCount <= 700) return "optimal length";
        if (_wordCount <= 900) return "slightly long";
        return "too long";
    }

    private static string GetScoreCss(int score) => score switch
    {
        >= 70 => "text-green",
        >= 50 => "text-cyan",
        >= 30 => "text-yellow",
        _ => "text-red"
    };

    private static string GetAttentionColor(string attention) => attention switch
    {
        "High" => "green",
        "Medium" => "yellow",
        "Low" => "red",
        "Skipped" => "gray",
        _ => "gray"
    };
}
