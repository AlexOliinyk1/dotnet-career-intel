@page "/linkedin/stats"
@inject DataDirectoryConfig DataDir
@rendermode InteractiveServer

<div class="page-header">
    <h1 class="page-title">Proposal Analytics</h1>
    <p>Insights from LinkedIn recruiter proposals</p>
</div>

<LoadingSpinner Loading="_loading" Message="Analyzing proposals..." />

@if (!_loading)
{
    @if (_stats == null || _stats.TotalProposals == 0)
    {
        <div class="card">
            <p style="text-align: center; padding: 2rem; color: var(--text-muted);">
                No proposal data available. Import LinkedIn messages on the
                <a href="/linkedin">Proposals page</a> first.
            </p>
        </div>
    }
    else
    {
        @* Stat Cards *@
        <div class="card-grid" style="margin-bottom: 1.5rem;">
            <StatCard Label="Total Proposals" Value="@_stats.TotalProposals.ToString()" />
            <StatCard Label="Date Range" Value="@_stats.DateRange" />
            <StatCard Label="Relocation Offers" Value="@_stats.RelocationOffers.ToString()"
                      Sub="@($"{(_stats.TotalProposals > 0 ? (double)_stats.RelocationOffers / _stats.TotalProposals * 100 : 0):F0}% of total")" />
            <StatCard Label="Avg Messages/Thread" Value="@_stats.AverageMessagesPerThread.ToString("F1")" />
        </div>

        @* Proposals Per Month *@
        <div class="card" style="margin-bottom: 1.5rem;">
            <h3 class="card-title">Proposals Per Month</h3>
            <BarChart Data="_stats.ProposalsPerMonth" />
        </div>

        @* Top Companies *@
        <div class="card" style="margin-bottom: 1.5rem;">
            <h3 class="card-title">Top Companies</h3>
            <BarChart Data="_stats.TopCompanies" />
        </div>

        @* Tech Stack Frequency *@
        <div class="card" style="margin-bottom: 1.5rem;">
            <h3 class="card-title">Tech Stack Frequency</h3>
            <BarChart Data="_stats.TechStackFrequency" />
        </div>

        @* Remote Breakdown *@
        <div class="card" style="margin-bottom: 1.5rem;">
            <h3 class="card-title">Remote Policy Breakdown</h3>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                @foreach (var (policy, count) in _stats.RemoteBreakdown.OrderByDescending(x => x.Value))
                {
                    var pct = _stats.TotalProposals > 0 ? (double)count / _stats.TotalProposals * 100 : 0;
                    <div class="stat-card" style="min-width: 140px;">
                        <StatusBadge Text="@policy" Color="@StatusBadge.GetColorForStatus(policy)" />
                        <div class="stat-value" style="margin-top: 0.5rem;">@count</div>
                        <div class="stat-sub">@($"{pct:F0}%")</div>
                    </div>
                }
            </div>
        </div>

        @* Status Breakdown *@
        <div class="card" style="margin-bottom: 1.5rem;">
            <h3 class="card-title">Status Breakdown</h3>
            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                @foreach (var (status, count) in _stats.StatusBreakdown.OrderByDescending(x => x.Value))
                {
                    <div style="display: flex; align-items: center; gap: 0.4rem;">
                        <StatusBadge Text="@status" Color="@StatusBadge.GetColorForStatus(status)" />
                        <span>@count</span>
                    </div>
                }
            </div>
        </div>

        @* Top Locations *@
        <div class="card" style="margin-bottom: 1.5rem;">
            <h3 class="card-title">Top Locations</h3>
            <BarChart Data="_stats.TopLocations" />
        </div>

        @* Common Job Titles *@
        <div class="card" style="margin-bottom: 1.5rem;">
            <h3 class="card-title">Common Job Titles</h3>
            <BarChart Data="_stats.CommonJobTitles" />
        </div>
    }
}

@code {
    private CareerIntel.Intelligence.ProposalStats? _stats;
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        var filePath = Path.Combine(DataDir.Path, "linkedin-proposals.json");

        if (File.Exists(filePath))
        {
            var json = await File.ReadAllTextAsync(filePath);
            var proposals = JsonSerializer.Deserialize<List<LinkedInProposal>>(json,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? [];

            var analyzer = new ProposalAnalyzer();
            _stats = analyzer.GetStatistics(proposals);
        }

        _loading = false;
    }
}
