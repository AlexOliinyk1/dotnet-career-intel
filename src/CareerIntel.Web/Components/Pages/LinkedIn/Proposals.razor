@page "/linkedin"
@inject DataDirectoryConfig DataDir
@rendermode InteractiveServer

<div class="page-header">
    <h1 class="page-title">LinkedIn Proposals</h1>
    <p>Recruiter messages extracted from LinkedIn export</p>
</div>

@* Import Section *@
<div class="card" style="margin-bottom: 1.5rem;">
    <h3 class="card-title">Import LinkedIn Messages</h3>
    <div class="form-group">
        <label>Upload LinkedIn data export (.zip)</label>
        <InputFile OnChange="HandleFileUpload" accept=".zip" />
        @if (!string.IsNullOrEmpty(_importMessage))
        {
            <p class="@(_importSuccess ? "text-green" : "text-red")" style="margin-top: 0.5rem;">@_importMessage</p>
        }
    </div>
</div>

@* Stat Cards *@
<div class="card-grid" style="margin-bottom: 1.5rem;">
    <StatCard Label="Total Proposals" Value="@_proposals.Count.ToString()" />
    <StatCard Label="New" Value="@_proposals.Count(p => p.Status == ProposalStatus.New).ToString()" CssClass="highlight-blue" />
    <StatCard Label="With Salary Info" Value="@_proposals.Count(p => !string.IsNullOrEmpty(p.SalaryHint)).ToString()" CssClass="highlight-green" />
</div>

@* Filter Bar *@
<div class="card" style="margin-bottom: 1.5rem;">
    <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: end;">
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <label>Company</label>
            <input type="text" @bind="_filterCompany" @bind:event="oninput" placeholder="Search company..." />
        </div>
        <div class="form-group" style="flex: 1; min-width: 160px;">
            <label>Status</label>
            <select @bind="_filterStatus">
                <option value="">All statuses</option>
                @foreach (var status in Enum.GetValues<ProposalStatus>())
                {
                    <option value="@status">@status</option>
                }
            </select>
        </div>
        <div class="form-group" style="flex: 1; min-width: 200px;">
            <label>Tech keyword</label>
            <input type="text" @bind="_filterTech" @bind:event="oninput" placeholder="e.g. .NET, React..." />
        </div>
        <div class="form-group">
            <button class="btn btn-primary" @onclick="ClearFilters">Clear</button>
        </div>
    </div>
</div>

@* Data Table *@
<LoadingSpinner Loading="_loading" Message="Loading proposals..." />

@if (!_loading)
{
    <div class="card">
        <h3 class="card-title">Proposals (@FilteredProposals.Count())</h3>
        <div class="data-table" style="overflow-x: auto;">
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Date</th>
                        <th>Recruiter</th>
                        <th>Company</th>
                        <th>Position</th>
                        <th>Tech Stack</th>
                        <th>Remote</th>
                        <th>Status</th>
                        <th>Update</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in FilteredProposals)
                    {
                        <tr>
                            <td>@p.Id</td>
                            <td>@p.ProposalDate.ToString("yyyy-MM-dd")</td>
                            <td>
                                @if (!string.IsNullOrEmpty(p.RecruiterProfileUrl))
                                {
                                    <a href="@p.RecruiterProfileUrl" target="_blank">@p.RecruiterName</a>
                                }
                                else
                                {
                                    @p.RecruiterName
                                }
                            </td>
                            <td class="truncate" style="max-width: 160px;">@p.Company</td>
                            <td class="truncate" style="max-width: 200px;">@p.JobTitle</td>
                            <td class="truncate" style="max-width: 180px;">@p.TechStack</td>
                            <td>
                                <StatusBadge Text="@p.RemotePolicy"
                                             Color="@StatusBadge.GetColorForStatus(p.RemotePolicy)" />
                            </td>
                            <td>
                                <StatusBadge Text="@p.Status.ToString()"
                                             Color="@StatusBadge.GetColorForStatus(p.Status.ToString())" />
                            </td>
                            <td>
                                <select value="@p.Status" @onchange="e => UpdateStatus(p, e)">
                                    @foreach (var status in Enum.GetValues<ProposalStatus>())
                                    {
                                        <option value="@status" selected="@(p.Status == status)">@status</option>
                                    }
                                </select>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (!FilteredProposals.Any())
        {
            <p style="text-align: center; padding: 2rem; color: var(--text-muted);">
                No proposals match the current filters.
            </p>
        }
    </div>
}

@code {
    private List<LinkedInProposal> _proposals = [];
    private bool _loading = true;
    private string _filterCompany = "";
    private string _filterStatus = "";
    private string _filterTech = "";
    private string _importMessage = "";
    private bool _importSuccess;

    private string DataFilePath => Path.Combine(DataDir.Path, "linkedin-proposals.json");

    private IEnumerable<LinkedInProposal> FilteredProposals => _proposals
        .Where(p => string.IsNullOrEmpty(_filterCompany)
            || p.Company.Contains(_filterCompany, StringComparison.OrdinalIgnoreCase))
        .Where(p => string.IsNullOrEmpty(_filterStatus)
            || p.Status.ToString() == _filterStatus)
        .Where(p => string.IsNullOrEmpty(_filterTech)
            || p.TechStack.Contains(_filterTech, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadProposals();
        _loading = false;
    }

    private async Task LoadProposals()
    {
        if (!File.Exists(DataFilePath))
            return;

        var json = await File.ReadAllTextAsync(DataFilePath);
        _proposals = JsonSerializer.Deserialize<List<LinkedInProposal>>(json,
            new JsonSerializerOptions { PropertyNameCaseInsensitive = true }) ?? [];
    }

    private async Task UpdateStatus(LinkedInProposal proposal, ChangeEventArgs e)
    {
        if (Enum.TryParse<ProposalStatus>(e.Value?.ToString(), out var newStatus))
        {
            proposal.Status = newStatus;
            await SaveProposals();
        }
    }

    private async Task SaveProposals()
    {
        var json = JsonSerializer.Serialize(_proposals, new JsonSerializerOptions { WriteIndented = true });
        await File.WriteAllTextAsync(DataFilePath, json);
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        try
        {
            _importMessage = "Uploading... (ZIP import parsing not yet implemented)";
            _importSuccess = false;

            var file = e.File;
            if (file == null || !file.Name.EndsWith(".zip", StringComparison.OrdinalIgnoreCase))
            {
                _importMessage = "Please select a .zip file exported from LinkedIn.";
                return;
            }

            // Save uploaded file to temp location
            var tempPath = Path.Combine(Path.GetTempPath(), $"linkedin-export-{Guid.NewGuid()}.zip");
            await using var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
            await using var fs = File.Create(tempPath);
            await stream.CopyToAsync(fs);

            _importMessage = $"File '{file.Name}' uploaded ({file.Size / 1024} KB). ZIP parsing will extract messages and merge with existing proposals.";
            _importSuccess = true;
        }
        catch (Exception ex)
        {
            _importMessage = $"Upload failed: {ex.Message}";
            _importSuccess = false;
        }
    }

    private void ClearFilters()
    {
        _filterCompany = "";
        _filterStatus = "";
        _filterTech = "";
    }
}
