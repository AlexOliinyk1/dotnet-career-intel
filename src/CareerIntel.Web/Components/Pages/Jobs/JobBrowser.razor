@page "/jobs"
@inject VacancyRepository VacancyRepo
@inject IEnumerable<IJobScraper> Scrapers
@using CareerIntel.Core.Interfaces

<div class="page-header">
    <h1 class="page-title">Job Browser</h1>
    <p class="page-subtitle">Browse and filter scraped vacancies across all platforms</p>
</div>

<div class="card" style="margin-bottom: 1rem;">
    <div class="form-row">
        <div class="form-group">
            <label>Search</label>
            <input type="text" @bind="_searchText" @bind:event="oninput"
                   placeholder="Search titles, companies..." />
        </div>
        <div class="form-group">
            <label>Platform</label>
            <select @bind="_selectedPlatform">
                <option value="">All Platforms</option>
                @foreach (var p in _platforms)
                {
                    <option value="@p">@p</option>
                }
            </select>
        </div>
        <div class="form-group">
            <label>Remote Policy</label>
            <select @bind="_selectedRemote">
                <option value="">Any</option>
                @foreach (var r in Enum.GetValues<RemotePolicy>())
                {
                    <option value="@r">@r</option>
                }
            </select>
        </div>
        <div class="form-group">
            <label>Seniority</label>
            <select @bind="_selectedSeniority">
                <option value="">Any</option>
                @foreach (var s in Enum.GetValues<SeniorityLevel>())
                {
                    <option value="@s">@s</option>
                }
            </select>
        </div>
        <div class="form-group" style="align-self: flex-end;">
            <button class="btn btn-primary" @onclick="ScanNow" disabled="@_scanning">
                @(_scanning ? "Scanning..." : "Scan Now")
            </button>
        </div>
    </div>
</div>

@if (_scanning)
{
    <LoadingSpinner Loading="true" Message="@_scanStatus" />
}

<LoadingSpinner Loading="@_loading" Message="Loading vacancies..." />

@if (!_loading)
{
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <span class="text-muted">
                Showing @FilteredVacancies.Count of @_allVacancies.Count vacancies
                (page @(_currentPage + 1) of @TotalPages)
            </span>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Company</th>
                    <th>Remote</th>
                    <th>Seniority</th>
                    <th>Salary</th>
                    <th>Platform</th>
                    <th>Posted</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var v in PagedVacancies)
                {
                    <tr @onclick="() => NavigateToDetail(v.Id)" style="cursor: pointer;">
                        <td class="truncate" style="max-width: 280px;">@v.Title</td>
                        <td>@v.Company</td>
                        <td>
                            <StatusBadge Text="@v.RemotePolicy.ToString()"
                                         Color="@StatusBadge.GetColorForStatus(v.RemotePolicy.ToString())" />
                        </td>
                        <td>@v.SeniorityLevel</td>
                        <td class="text-cyan">@FormatSalary(v)</td>
                        <td><span class="badge">@v.SourcePlatform</span></td>
                        <td class="text-muted">@v.PostedDate.ToString("MMM dd")</td>
                    </tr>
                }
            </tbody>
        </table>

        @if (TotalPages > 1)
        {
            <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem;">
                <button class="btn" disabled="@(_currentPage == 0)" @onclick="PreviousPage">Previous</button>
                @for (var i = PaginationStart; i <= PaginationEnd; i++)
                {
                    var pageIndex = i;
                    <button class="btn @(pageIndex == _currentPage ? "btn-primary" : "")"
                            @onclick="() => GoToPage(pageIndex)">
                        @(pageIndex + 1)
                    </button>
                }
                <button class="btn" disabled="@(_currentPage >= TotalPages - 1)" @onclick="NextPage">Next</button>
            </div>
        }
    </div>
}

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private const int PageSize = 25;

    private bool _loading = true;
    private bool _scanning;
    private string _scanStatus = "Starting scan...";

    private List<JobVacancy> _allVacancies = [];
    private List<string> _platforms = [];
    private int _currentPage;

    // Filters
    private string _searchText = "";
    private string _selectedPlatform = "";
    private string _selectedRemote = "";
    private string _selectedSeniority = "";

    private List<JobVacancy> FilteredVacancies
    {
        get
        {
            var query = _allVacancies.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(_searchText))
            {
                var search = _searchText.Trim();
                query = query.Where(v =>
                    v.Title.Contains(search, StringComparison.OrdinalIgnoreCase) ||
                    v.Company.Contains(search, StringComparison.OrdinalIgnoreCase));
            }

            if (!string.IsNullOrEmpty(_selectedPlatform))
                query = query.Where(v => v.SourcePlatform == _selectedPlatform);

            if (!string.IsNullOrEmpty(_selectedRemote) && Enum.TryParse<RemotePolicy>(_selectedRemote, out var remote))
                query = query.Where(v => v.RemotePolicy == remote);

            if (!string.IsNullOrEmpty(_selectedSeniority) && Enum.TryParse<SeniorityLevel>(_selectedSeniority, out var seniority))
                query = query.Where(v => v.SeniorityLevel == seniority);

            return query.ToList();
        }
    }

    private int TotalPages => Math.Max(1, (int)Math.Ceiling((double)FilteredVacancies.Count / PageSize));

    private int PaginationStart => Math.Max(0, _currentPage - 3);
    private int PaginationEnd => Math.Min(TotalPages - 1, _currentPage + 3);

    private List<JobVacancy> PagedVacancies => FilteredVacancies
        .Skip(_currentPage * PageSize)
        .Take(PageSize)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        _allVacancies = await VacancyRepo.GetVacanciesAsync();

        _platforms = _allVacancies
            .Select(v => v.SourcePlatform)
            .Distinct()
            .OrderBy(p => p)
            .ToList();

        _loading = false;
    }

    private async Task ScanNow()
    {
        _scanning = true;
        var scraperList = Scrapers.ToList();
        var totalNew = 0;

        for (var i = 0; i < scraperList.Count; i++)
        {
            var scraper = scraperList[i];
            _scanStatus = $"Scanning {scraper.PlatformName} ({i + 1}/{scraperList.Count})...";
            StateHasChanged();

            try
            {
                var results = await scraper.ScrapeAsync();
                if (results.Count > 0)
                {
                    await VacancyRepo.SaveVacanciesAsync(results);
                    totalNew += results.Count;
                }
            }
            catch
            {
                // Skip failed scrapers silently
            }
        }

        _scanStatus = $"Scan complete. {totalNew} vacancies collected.";
        StateHasChanged();

        // Reload data
        _allVacancies = await VacancyRepo.GetVacanciesAsync();
        _platforms = _allVacancies
            .Select(v => v.SourcePlatform)
            .Distinct()
            .OrderBy(p => p)
            .ToList();

        _currentPage = 0;
        _scanning = false;
    }

    private void NavigateToDetail(string id) => Navigation.NavigateTo($"/jobs/{id}");

    private void GoToPage(int page) => _currentPage = page;
    private void PreviousPage() { if (_currentPage > 0) _currentPage--; }
    private void NextPage() { if (_currentPage < TotalPages - 1) _currentPage++; }

    private static string FormatSalary(JobVacancy v)
    {
        if (!v.SalaryMin.HasValue)
            return "-";

        var min = v.SalaryMin.Value.ToString("N0");
        var currency = v.SalaryCurrency;

        if (v.SalaryMax.HasValue)
            return $"{currency} {min} - {v.SalaryMax.Value:N0}";

        return $"{currency} {min}+";
    }
}
