@page "/settings/change-password"
@layout EmptyLayout
@inject NavigationManager Navigation
@inject AuthConfig AuthCfg

<div class="login-wrapper">
    <div class="login-card">
        <div class="login-brand">
            <span class="brand-icon" aria-hidden="true">CI</span>
            <span class="brand-text">CareerIntel</span>
        </div>

        @if (AuthCfg.MustChangePassword)
        {
            <p class="login-subtitle" style="color: var(--yellow);">You must change the default password before continuing.</p>
        }
        else
        {
            <p class="login-subtitle">Change your password</p>
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="login-error" role="alert">@_errorMessage</div>
        }

        <form method="post" action="/api/auth/change-password">
            <AntiforgeryToken />

            @if (!AuthCfg.MustChangePassword)
            {
                <div class="form-group">
                    <label for="currentPassword">Current Password</label>
                    <input id="currentPassword" type="password" name="currentPassword"
                           placeholder="Enter current password" autocomplete="current-password"
                           required style="width: 100%;" />
                </div>
            }

            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input id="newPassword" type="password" name="newPassword"
                       placeholder="Minimum 8 characters" autocomplete="new-password"
                       required minlength="8" style="width: 100%;" />
            </div>

            <div class="form-group">
                <label for="confirmPassword">Confirm New Password</label>
                <input id="confirmPassword" type="password" name="confirmPassword"
                       placeholder="Repeat new password" autocomplete="new-password"
                       required minlength="8" style="width: 100%;" />
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">
                Change Password
            </button>
        </form>

        @if (!AuthCfg.MustChangePassword)
        {
            <p class="login-footer"><a href="/">Back to Dashboard</a></p>
        }
    </div>
</div>

@code {
    private string _errorMessage = "";

    protected override void OnInitialized()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        _errorMessage = query["error"] switch
        {
            "complexity" => "Password must be at least 8 characters and include uppercase, lowercase, and a digit.",
            "length" => "Password must be at least 8 characters.",
            "mismatch" => "Passwords do not match.",
            "wrong" => "Current password is incorrect.",
            _ => ""
        };
    }
}
