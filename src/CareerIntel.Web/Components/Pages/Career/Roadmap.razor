@page "/career/roadmap"
@inject VacancyRepository VacancyRepo
@inject DataDirectoryConfig DataDir
@using CareerIntel.Intelligence

<div class="page-header">
    <h1 class="page-title">Career Roadmap</h1>
    <p class="page-subtitle">Personalized career direction recommendations based on your skills and market data</p>
</div>

<LoadingSpinner Loading="@_loading" Message="Generating career roadmap..." />

@if (!_loading && !_hasSkills)
{
    <div class="card" style="text-align: center; padding: 2rem;">
        <p style="font-size: 1.1rem; margin-bottom: 1rem;">
            Add your skills in the Profile page first to get personalized recommendations.
        </p>
        <a href="/settings/profile" class="btn btn-primary">Go to Profile</a>
    </div>
}

@if (!_loading && _hasSkills && _roadmap is not null)
{
    <div class="card-grid">
        <StatCard Label="Your Skills"
                  Value="@_roadmap.CurrentSkillCount.ToString()"
                  Sub="skills in your profile" />
        <StatCard Label="Recommended Direction"
                  Value="@_roadmap.RecommendedDirection"
                  Sub="best fit for your profile"
                  CssClass="text-cyan" />
        <StatCard Label="Skill Gaps"
                  Value="@_roadmap.SkillGaps.Count.ToString()"
                  Sub="high-demand skills to learn"
                  CssClass="text-yellow" />
    </div>

    @* --- Scored Career Directions --- *@
    <h2 class="section-title" style="margin-top: 2rem;">Career Directions (Ranked)</h2>

    @for (var rank = 0; rank < _roadmap.ScoredDirections.Count; rank++)
    {
        var sd = _roadmap.ScoredDirections[rank];
        var isTop = rank == 0;
        var dir = sd.Direction;

        <div class="card" style="margin-bottom: 1.25rem; @(isTop ? "border-left: 3px solid var(--color-cyan);" : "")">
            @* Top: Rank + Name + Description *@
            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
                <span style="
                    display: inline-flex; align-items: center; justify-content: center;
                    min-width: 2rem; height: 2rem; border-radius: 50%;
                    background: var(--bg-hover); font-weight: 700; font-size: 0.95rem;
                    @(isTop ? "background: var(--color-cyan); color: var(--bg-primary);" : "")
                ">@(rank + 1)</span>
                <div>
                    <h3 style="margin: 0; font-size: 1.1rem;">@dir.Name</h3>
                    <p class="text-muted" style="margin: 0.25rem 0 0 0; font-size: 0.9rem;">@dir.Description</p>
                </div>
            </div>

            @* Composite Score Bar *@
            <div style="margin-bottom: 0.75rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                    <span style="font-size: 0.85rem; font-weight: 600;">Composite Score</span>
                    <span class="text-cyan" style="font-weight: 700;">@($"{sd.CompositeScore:F1}")</span>
                </div>
                <div style="width: 100%; height: 8px; background: var(--bg-hover); border-radius: 4px; overflow: hidden;">
                    <div style="
                        width: @(Math.Min(sd.CompositeScore / _maxScore * 100, 100).ToString("F1"))%;
                        height: 100%;
                        background: var(--color-@GetScoreColor(sd.CompositeScore));
                        border-radius: 4px;
                    "></div>
                </div>
            </div>

            @* Middle Row: Salary | Growth | AI Resilience *@
            <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 0.75rem; font-size: 0.9rem;">
                <div>
                    <span class="text-muted">Salary:</span>
                    <strong class="text-cyan">@($"{dir.SalaryMultiplier:F1}x") avg</strong>
                </div>
                <div>
                    <span class="text-muted">Growth:</span>
                    <strong class="@(dir.MarketGrowthRate >= 0 ? "text-green" : "text-red")">
                        @(dir.MarketGrowthRate >= 0 ? "+" : "")@(dir.MarketGrowthRate)%
                    </strong>
                </div>
                <div>
                    <span class="text-muted">AI Resilience:</span>
                    <strong>@dir.AiResilienceScore</strong>
                    <span class="text-muted">/100</span>
                </div>
            </div>

            @* Skills: You Have + To Learn *@
            <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 0.75rem;">
                @if (sd.SkillsYouHave.Count > 0)
                {
                    <div>
                        <span style="font-size: 0.85rem; font-weight: 600;">You have:</span>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.3rem;">
                            @foreach (var skill in sd.SkillsYouHave)
                            {
                                <span class="badge badge-green">@skill</span>
                            }
                        </div>
                    </div>
                }
                @if (sd.SkillsToLearn.Count > 0)
                {
                    <div>
                        <span style="font-size: 0.85rem; font-weight: 600;">Learn:</span>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.3rem;">
                            @foreach (var skill in sd.SkillsToLearn)
                            {
                                <span class="badge badge-yellow">@skill</span>
                            }
                        </div>
                    </div>
                }
            </div>

            @* Skill Overlap Bar *@
            <div style="font-size: 0.85rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.2rem;">
                    <span class="text-muted">Skill Overlap</span>
                    <span style="font-weight: 600;">@($"{sd.SkillOverlapPercent:F0}%")</span>
                </div>
                <div style="width: 100%; height: 6px; background: var(--bg-hover); border-radius: 3px; overflow: hidden;">
                    <div style="
                        width: @($"{sd.SkillOverlapPercent:F0}")%;
                        height: 100%;
                        background: var(--color-@GetOverlapColor(sd.SkillOverlapPercent));
                        border-radius: 3px;
                    "></div>
                </div>
            </div>
        </div>
    }

    @* --- Skill Gaps Table --- *@
    @if (_roadmap.SkillGaps.Count > 0)
    {
        <h2 class="section-title" style="margin-top: 2rem;">Skill Gaps</h2>

        <div class="card">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Skill</th>
                        <th>Market Demand %</th>
                        <th>Trend</th>
                        <th>Priority</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var gap in _roadmap.SkillGaps)
                    {
                        <tr>
                            <td><strong>@gap.SkillName</strong></td>
                            <td>
                                <span class="@GetDemandColor(gap.MarketDemandPercent)">
                                    @($"{gap.MarketDemandPercent:F1}%")
                                </span>
                            </td>
                            <td>
                                <StatusBadge Text="@gap.TrendDirection"
                                             Color="@GetTrendColor(gap.TrendDirection)" />
                            </td>
                            <td>
                                <StatusBadge Text="@gap.Priority"
                                             Color="@StatusBadge.GetColorForStatus(gap.Priority)" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
}

@code {
    private bool _loading = true;
    private bool _hasSkills;
    private CareerRoadmap? _roadmap;
    private double _maxScore = 100;

    private readonly CareerEvolutionEngine _engine = new();

    protected override async Task OnInitializedAsync()
    {
        var userSkills = await LoadUserSkills();
        _hasSkills = userSkills.Count > 0;

        if (_hasSkills)
        {
            var vacancies = await VacancyRepo.GetVacanciesAsync();
            _roadmap = _engine.GenerateRoadmap(vacancies, userSkills);

            if (_roadmap.ScoredDirections.Count > 0)
                _maxScore = _roadmap.ScoredDirections[0].CompositeScore;

            if (_maxScore <= 0) _maxScore = 1;
        }

        _loading = false;
    }

    private async Task<List<string>> LoadUserSkills()
    {
        var path = Path.Combine(DataDir.Path, "my-profile.json");
        if (!File.Exists(path)) return [];
        try
        {
            var json = await File.ReadAllTextAsync(path);
            using var doc = JsonDocument.Parse(json);
            if (doc.RootElement.TryGetProperty("skills", out var skills) && skills.ValueKind == JsonValueKind.Array)
                return skills.EnumerateArray()
                    .Select(s => s.GetString() ?? "")
                    .Where(s => !string.IsNullOrWhiteSpace(s))
                    .ToList();
        }
        catch { }
        return [];
    }

    private static string GetScoreColor(double score) => score switch
    {
        >= 50 => "cyan",
        >= 30 => "yellow",
        _ => "red"
    };

    private static string GetOverlapColor(double pct) => pct switch
    {
        >= 60 => "green",
        >= 30 => "cyan",
        >= 10 => "yellow",
        _ => "red"
    };

    private static string GetDemandColor(double pct) => pct switch
    {
        >= 30 => "text-green",
        >= 15 => "text-cyan",
        >= 5 => "text-yellow",
        _ => "text-muted"
    };

    private static string GetTrendColor(string trend) => trend switch
    {
        "Rising" => "green",
        "Stable" => "yellow",
        "Declining" => "red",
        _ => "gray"
    };
}
