@page "/companies"
@inject VacancyRepository VacancyRepo
@inject CompanyDiscoveryEngine DiscoveryEngine
@inject CompanyRepository CompanyRepo

<div class="page-header">
    <h1 class="page-title">Company Discovery</h1>
    <p class="page-subtitle">Browse companies from scraped vacancies grouped by hiring volume</p>
</div>

<div class="card" style="margin-bottom: 1rem;">
    <div class="form-row">
        <div class="form-group">
            <label>Search Company</label>
            <input type="text" @bind="_searchText" @bind:event="oninput"
                   placeholder="Filter by company name..." />
        </div>
        <div class="form-group">
            <label>Tech Stack Filter</label>
            <input type="text" @bind="_techFilter" @bind:event="oninput"
                   placeholder="e.g. C#, Azure, Docker..." />
        </div>
        <div class="form-group" style="align-self: flex-end;">
            <button class="btn btn-primary" @onclick="RunDiscovery" disabled="@_discovering">
                @(_discovering ? "Discovering..." : "Run Discovery")
            </button>
        </div>
    </div>
</div>

<LoadingSpinner Loading="@_loading" Message="Loading companies..." />

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="card" style="margin-bottom: 1rem; border-color: var(--red);">
        <p style="color: var(--red);">@_errorMessage</p>
    </div>
}

@if (!_loading)
{
    <div class="card-grid" style="margin-bottom: 1rem;">
        <StatCard Label="Total Companies" Value="@_companyRows.Count.ToString()" />
        <StatCard Label="Total Jobs" Value="@_allVacancies.Count.ToString()" />
        <StatCard Label="Avg Remote %" Value="@($"{OverallRemotePercent:F0}%")" />
        <StatCard Label="Confirmed UA Hiring" Value="@_discoveredCompanies.Count(c => c.ConfirmedUkraineHiring).ToString()" />
    </div>

    @if (_discoveredCompanies.Count > 0)
    {
        <div class="card" style="margin-bottom: 1rem;">
            <h2 class="card-title">Top Discovered Companies (by composite score)</h2>
            <p class="text-muted" style="margin-bottom: 0.75rem;">
                @_discoveredCompanies.Count discovered, @_persistedProfiles.Count with persisted profiles
            </p>
        </div>
    }

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
            <span class="text-muted">
                Showing @FilteredCompanies.Count of @_companyRows.Count companies
            </span>
        </div>

        <table class="data-table">
            <thead>
                <tr>
                    <th style="cursor: pointer;" @onclick="() => SortBy(nameof(CompanyRow.CompanyName))">
                        Company Name @SortIndicator(nameof(CompanyRow.CompanyName))
                    </th>
                    <th style="cursor: pointer;" @onclick="() => SortBy(nameof(CompanyRow.JobCount))">
                        Job Count @SortIndicator(nameof(CompanyRow.JobCount))
                    </th>
                    <th style="cursor: pointer;" @onclick="() => SortBy(nameof(CompanyRow.RemotePercent))">
                        Remote % @SortIndicator(nameof(CompanyRow.RemotePercent))
                    </th>
                    <th style="cursor: pointer;" @onclick="() => SortBy(nameof(CompanyRow.AvgSalary))">
                        Avg Salary @SortIndicator(nameof(CompanyRow.AvgSalary))
                    </th>
                    <th>Platforms</th>
                    <th>Profile</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var row in PagedCompanies)
                {
                    <tr @onclick="() => NavigateToJobs(row.CompanyName)" style="cursor: pointer;">
                        <td>
                            <strong>@row.CompanyName</strong>
                            @if (row.ConfirmedUkraineHiring)
                            {
                                <StatusBadge Text="UA" Color="green" />
                            }
                        </td>
                        <td class="text-cyan">@row.JobCount</td>
                        <td>
                            <StatusBadge Text="@($"{row.RemotePercent:F0}%")"
                                         Color="@(row.RemotePercent >= 80 ? "green" : row.RemotePercent >= 40 ? "yellow" : "gray")" />
                        </td>
                        <td class="text-cyan">
                            @(row.AvgSalary > 0 ? $"${row.AvgSalary:N0}" : "-")
                        </td>
                        <td>
                            @foreach (var platform in row.Platforms)
                            {
                                <span class="badge" style="margin-right: 0.25rem;">@platform</span>
                            }
                        </td>
                        <td>
                            @if (row.HasPersistedProfile)
                            {
                                <StatusBadge Text="Saved" Color="cyan" />
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem;">
            <button class="btn" disabled="@(_currentPage == 0)" @onclick="PreviousPage">Previous</button>
            @for (var i = PaginationStart; i <= PaginationEnd; i++)
            {
                var pageIndex = i;
                <button class="btn @(pageIndex == _currentPage ? "btn-primary" : "")"
                        @onclick="() => GoToPage(pageIndex)">
                    @(pageIndex + 1)
                </button>
            }
            <button class="btn" disabled="@(_currentPage >= TotalPages - 1)" @onclick="NextPage">Next</button>
        </div>
    </div>
}

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private const int PageSize = 25;

    private bool _loading = true;
    private bool _discovering;
    private string? _errorMessage;
    private List<JobVacancy> _allVacancies = [];
    private List<CompanyRow> _companyRows = [];
    private List<UkraineFriendlyCompany> _discoveredCompanies = [];
    private List<CompanyProfile> _persistedProfiles = [];
    private int _currentPage;
    private string _searchText = "";
    private string _techFilter = "";
    private string _sortColumn = nameof(CompanyRow.JobCount);
    private bool _sortDescending = true;

    private double OverallRemotePercent => _allVacancies.Count > 0
        ? _allVacancies.Count(v => v.RemotePolicy == RemotePolicy.FullyRemote) * 100.0 / _allVacancies.Count
        : 0;

    private List<CompanyRow> FilteredCompanies
    {
        get
        {
            var query = _companyRows.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(_searchText))
            {
                var search = _searchText.Trim();
                query = query.Where(r => r.CompanyName.Contains(search, StringComparison.OrdinalIgnoreCase));
            }

            if (!string.IsNullOrWhiteSpace(_techFilter))
            {
                var skills = _techFilter.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(s => s.Trim())
                    .Where(s => s.Length > 0)
                    .ToList();

                if (skills.Count > 0)
                {
                    query = query.Where(r => r.TechStack.Any(t =>
                        skills.Any(s => t.Contains(s, StringComparison.OrdinalIgnoreCase))));
                }
            }

            query = _sortColumn switch
            {
                nameof(CompanyRow.CompanyName) => _sortDescending
                    ? query.OrderByDescending(r => r.CompanyName)
                    : query.OrderBy(r => r.CompanyName),
                nameof(CompanyRow.RemotePercent) => _sortDescending
                    ? query.OrderByDescending(r => r.RemotePercent)
                    : query.OrderBy(r => r.RemotePercent),
                nameof(CompanyRow.AvgSalary) => _sortDescending
                    ? query.OrderByDescending(r => r.AvgSalary)
                    : query.OrderBy(r => r.AvgSalary),
                _ => _sortDescending
                    ? query.OrderByDescending(r => r.JobCount)
                    : query.OrderBy(r => r.JobCount),
            };

            return query.ToList();
        }
    }

    private int TotalPages => Math.Max(1, (int)Math.Ceiling((double)FilteredCompanies.Count / PageSize));
    private int PaginationStart => Math.Max(0, _currentPage - 3);
    private int PaginationEnd => Math.Min(TotalPages - 1, _currentPage + 3);

    private List<CompanyRow> PagedCompanies => FilteredCompanies
        .Skip(_currentPage * PageSize)
        .Take(PageSize)
        .ToList();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _allVacancies = await VacancyRepo.GetVacanciesAsync();
            _persistedProfiles = await CompanyRepo.GetAllAsync();

            // Use CompanyDiscoveryEngine to discover companies from vacancies
            _discoveredCompanies = DiscoveryEngine.DiscoverFromVacancies(_allVacancies);

            var profileLookup = _persistedProfiles
                .ToDictionary(p => p.Name, p => p, StringComparer.OrdinalIgnoreCase);

            _companyRows = _discoveredCompanies
                .Select(c =>
                {
                    return new CompanyRow
                    {
                        CompanyName = c.Name,
                        JobCount = c.VacancyCount,
                        RemotePercent = c.VacancyCount > 0
                            ? c.RemoteVacancyCount * 100.0 / c.VacancyCount
                            : 0,
                        AvgSalary = c.AvgSalaryMin.HasValue
                            ? (double)((c.AvgSalaryMin.Value + (c.AvgSalaryMax ?? c.AvgSalaryMin.Value)) / 2)
                            : 0,
                        Platforms = c.Sources,
                        TechStack = c.TechStack,
                        ConfirmedUkraineHiring = c.ConfirmedUkraineHiring,
                        HasPersistedProfile = profileLookup.ContainsKey(c.Name)
                    };
                })
                .ToList();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load company data: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RunDiscovery()
    {
        _discovering = true;
        _errorMessage = null;

        try
        {
            _allVacancies = await VacancyRepo.GetVacanciesAsync();
            var discovered = DiscoveryEngine.DiscoverFromVacancies(_allVacancies);

            // Merge with previously discovered data
            _discoveredCompanies = DiscoveryEngine.MergeWithExisting(_discoveredCompanies, discovered);

            // Apply tech stack filter if provided
            if (!string.IsNullOrWhiteSpace(_techFilter))
            {
                var skills = _techFilter.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(s => s.Trim())
                    .Where(s => s.Length > 0);

                _discoveredCompanies = DiscoveryEngine.FilterByTechStack(_discoveredCompanies, skills);
            }

            // Reload persisted profiles
            _persistedProfiles = await CompanyRepo.GetAllAsync();
            var profileLookup = _persistedProfiles
                .ToDictionary(p => p.Name, p => p, StringComparer.OrdinalIgnoreCase);

            _companyRows = _discoveredCompanies
                .Select(c => new CompanyRow
                {
                    CompanyName = c.Name,
                    JobCount = c.VacancyCount,
                    RemotePercent = c.VacancyCount > 0
                        ? c.RemoteVacancyCount * 100.0 / c.VacancyCount
                        : 0,
                    AvgSalary = c.AvgSalaryMin.HasValue
                        ? (double)((c.AvgSalaryMin.Value + (c.AvgSalaryMax ?? c.AvgSalaryMin.Value)) / 2)
                        : 0,
                    Platforms = c.Sources,
                    TechStack = c.TechStack,
                    ConfirmedUkraineHiring = c.ConfirmedUkraineHiring,
                    HasPersistedProfile = profileLookup.ContainsKey(c.Name)
                })
                .ToList();

            _currentPage = 0;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Discovery failed: {ex.Message}";
        }
        finally
        {
            _discovering = false;
        }
    }

    private void SortBy(string column)
    {
        if (_sortColumn == column)
            _sortDescending = !_sortDescending;
        else
        {
            _sortColumn = column;
            _sortDescending = true;
        }
        _currentPage = 0;
    }

    private string SortIndicator(string column)
    {
        if (_sortColumn != column) return "";
        return _sortDescending ? " v" : " ^";
    }

    private void NavigateToJobs(string companyName)
    {
        Navigation.NavigateTo($"/jobs?search={Uri.EscapeDataString(companyName)}");
    }

    private void GoToPage(int page) => _currentPage = page;
    private void PreviousPage() { if (_currentPage > 0) _currentPage--; }
    private void NextPage() { if (_currentPage < TotalPages - 1) _currentPage++; }

    private sealed class CompanyRow
    {
        public string CompanyName { get; set; } = string.Empty;
        public int JobCount { get; set; }
        public double RemotePercent { get; set; }
        public double AvgSalary { get; set; }
        public List<string> Platforms { get; set; } = [];
        public List<string> TechStack { get; set; } = [];
        public bool ConfirmedUkraineHiring { get; set; }
        public bool HasPersistedProfile { get; set; }
    }
}
